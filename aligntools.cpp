//Program to calculate predicted sigma values for loci in a model system, where data is generated by a sampling process
//This code uses a deterministic method to run the underlying population distribution, and samples it at low frequency

#include <iostream>
#include <sstream>
#include <vector>
#include <list>
#include <deque>
using namespace std;

#include "aligntools.h"
#include "distance_matrix.h"
#include "diversity.h"
#include "io.h"
#include "rgen.h"
#include "timesplit.h"
#include "utilities.h"
#include <Eigen/Dense>

int main(int argc, const char **argv){

    //Code to read in an alignment.
    //Identifies variants and will make covariance matrix between these sites.
    
    //Initialise random number generator
    
	run_params p;
	GetParameters(p,argc,argv);
    p.seed=(int) time(NULL);
    gsl_rng_env_setup();
    gsl_rng *rgen = gsl_rng_alloc (gsl_rng_taus);
    gsl_rng_set (rgen, p.seed);
    
    vector<string> seqs;
    vector<string> names;
    ReadFastaAli(p,seqs,names);
    CheckBaseCase(seqs);
    
    if (p.method.compare("DistanceMatrix")==0) {
        vector< vector<int> > seqdists;
        MakeDistanceMatrix (p,1,seqs,names,seqdists);
        return 0;
    }
    
    //Get alignment statistics
    vector<site> ali_stats;
    GetAliStats (seqs,ali_stats);
    
    //Consensus sequence
    vector<string> consensus;
    GetConsensus(ali_stats,consensus);
    int seq_length=consensus.size();
  

    //Next step - variant positions
    vector<int> var_positions;
    FindVariants (ali_stats,var_positions);
    
    if (p.method.compare("Diversity")==0) {
        GetPiDiversity (p,seq_length,seqs,names);
        return 0;
    }
    
    if (p.method.compare("Random")==0) {
        
        GenerateRandomSequences (p,seq_length,consensus,var_positions,ali_stats,seqs);
        
    } else if (p.method.compare("TimedFreqs")==0) {
        
        GetTDNucleotideCounts (p,consensus,var_positions,ali_stats,seqs);
        
        
    } else {
        cout << "Instructions:\n";
        cout << "./run_align DistanceMatrix <flags> : Calculates matrix of distances between sequences.\n";
        cout << "./run_align Diversity <flags> : Calculates pi diversity for sequences in the alignment.\n";
        cout << "./run_align Random <flags> : Generates random sequences.\n";
        cout << "./run_align TimedFreqs <flags> : Separates sequences in an alignment by time and produces records of variant frequency over time.\n";
        cout << "Official flags are:\n";
        cout << " --ali_file <file> : Multiple sequence alignment file in .fasta format\n";
        cout << "In Random:\n";
        cout << " --generate <number> : Number of random sequences to generate\n";
        cout << " --verb <number> : Write out variant details to file\n";
        cout << " --output <type> : Output format for random files:\n";
        cout << "       Sparse: [Default] Output positions of variants w.r.t. consensus\n";
        cout << "       FASTA: Output as .fasta file format\n";
        cout << "       Binary: Output as binary string at variant positions\n";
        cout << "In TimeFreqs:\n";
        cout << " --q_cut <frequency> : [Default 0.1] Minimum minor allele frequency to report\n";
        cout << " --n_cut <value> : [Default 10] Minimum read depth when calling variant allele\n";
        cout << " --n_reps <type> : [Default 1] Minimum number of times variant observed at given frequency and read depth:\n";

    }
    
    return 0;
    
            
    return 0;
}
	
	
